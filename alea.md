- promotions
    - percentage => prix 
    - date promotions
    - cumul

- reservations
    - reservations ray => billet ray
    - vol
    - categorie
    - date reservations

- payement
    - status paye non paye
    - 



how to modify the code logic of the reservation to add a cumulative seat promotional functionality ? 
for example: 

NB: 
(
    - the discount_percentage has been changed directly to the promotional price instead of giving a percentage, i havent change the name but i just change the affichage label and removed the discount percentage logic and replace it directly with the romotional price (dont change anything there, it works fine)
    - the date butoire to book a flight is the column `date_promotion` in `FlightPromotion`
) 



for a flight A, there is 10 seats in promotion at 100$ for the category Economic for 18/08/2025 and date end reservation is 19/08/2025

-> seats avalaible at promotion => 10
-> a client booked and payed 3 seats the 18/08/2025 for the flight A at the category Economic
-> another client booked 1 seat the same date but he didn't payed the seat
-> 3 seats booked and payed
-> 1 seat booked but not payed
-> total booked => 4
    -> total payed => 3
    -> total unpayed => 1
-> remaining seats: 10 - 4 = 6 seats unbooked 

always in the flight A, there is 5 new seats in promotion at 85$ for the category Ecomomic for 20/08/2025

-> seats avalaible at promotion => 5 
-> remaining unbooked where it is the same flight and the same category is => 6 
-> total seat for promotion avalaible at 85$ ->  5 + 6 = 11

the previous unbooked seats is cumulated to the next promotion because it has the same flight and the same category


==> if there is no mathcing flight and category to an unbooked flight, we just cancel it
==> otherwise we find the next matching promotion, and add the unbookend seat




Do you understand the logic ? 


I want to create a page called "Manage unbooked Seat" with a formulaire and in this it will have just a date input
when i submit the date in this form, you need to create a method in a service class who take the date as param and maybe a connexion to DB

the method will replicate the logic that ive explained to you


To sump up when i trigger the btn in the form, if there is matching flight and category to the unbooked seat, we moved them to have this new promotional price, otherwise, if a seat has been booked but not payed, we cancel the reservation, and if there is no matching flight and category we delete the promotion on those seats



/**---------------------------**/


For this Given DB conception: 

```

CREATE TABLE public.categorie_age (
	id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	"label" varchar(255) NOT NULL,
	CONSTRAINT categorie_age_pkey PRIMARY KEY (id)
);


CREATE TABLE public.cities (
	id serial4 NOT NULL,
	city_name varchar(100) NOT NULL,
	country varchar(100) NOT NULL,
	CONSTRAINT cities_city_name_country_key UNIQUE (city_name, country),
	CONSTRAINT cities_pkey PRIMARY KEY (id)
);


CREATE TABLE public.clients (
	id serial4 NOT NULL,
	"name" varchar(255) NOT NULL,
	email varchar(255) NOT NULL,
	password_hash varchar(255) NOT NULL,
	passport_image varchar(255) NULL,
	CONSTRAINT clients_email_key UNIQUE (email),
	CONSTRAINT clients_pkey PRIMARY KEY (id)
);


CREATE TABLE public.planes (
	id serial4 NOT NULL,
	model_name varchar(100) NOT NULL,
	fabrication_date date NOT NULL,
	CONSTRAINT planes_pkey PRIMARY KEY (id)
);


CREATE TABLE public.flights (
	id serial4 NOT NULL,
	flight_number varchar(20) NOT NULL,
	id_plane int4 NULL,
	id_origin_city int4 NULL,
	id_destination_city int4 NULL,
	departure_time timestamptz NOT NULL,
	arrival_time timestamptz NOT NULL,
	reservation_deadline_hours int4 DEFAULT 3 NOT NULL,
	cancellation_deadline_hours int4 DEFAULT 24 NOT NULL,
	CONSTRAINT flights_cancellation_deadline_hours_check CHECK ((cancellation_deadline_hours >= 0)),
	CONSTRAINT flights_check CHECK ((id_origin_city <> id_destination_city)),
	CONSTRAINT flights_check1 CHECK ((arrival_time > departure_time)),
	CONSTRAINT flights_flight_number_key UNIQUE (flight_number),
	CONSTRAINT flights_pkey PRIMARY KEY (id),
	CONSTRAINT flights_reservation_deadline_hours_check CHECK ((reservation_deadline_hours >= 0)),
	CONSTRAINT flights_id_destination_city_fkey FOREIGN KEY (id_destination_city) REFERENCES public.cities(id) ON DELETE RESTRICT,
	CONSTRAINT flights_id_origin_city_fkey FOREIGN KEY (id_origin_city) REFERENCES public.cities(id) ON DELETE RESTRICT,
	CONSTRAINT flights_id_plane_fkey FOREIGN KEY (id_plane) REFERENCES public.planes(id) ON DELETE RESTRICT
);


CREATE TABLE public.percentage_discount (
	id int4 GENERATED BY DEFAULT AS IDENTITY( INCREMENT BY 1 MINVALUE 1 MAXVALUE 2147483647 START 1 CACHE 1 NO CYCLE) NOT NULL,
	age_max int4 NOT NULL,
	id_categorie_age int4 NOT NULL,
	percentage_discount float8 NULL,
	CONSTRAINT percentage_discount_pkey PRIMARY KEY (id),
	CONSTRAINT fk1i3lcfu91vltj6epmb3q35x25 FOREIGN KEY (id_categorie_age) REFERENCES public.categorie_age(id)
);


CREATE TABLE public.reservations (
	id serial4 NOT NULL,
	id_client int4 NULL,
	id_flight int4 NULL,
	reservation_time timestamptz DEFAULT CURRENT_TIMESTAMP NULL,
	nbr_billet_total int4 NOT NULL,
	nbr_billet_enfant int4 NOT NULL,
	nbr_billet_adulte int4 NOT NULL,
	payment_status varchar(50) DEFAULT 'pending'::character varying NOT NULL,
	payment_time timestamptz NULL,
	CONSTRAINT reservations_pkey PRIMARY KEY (id),
	CONSTRAINT reservations_id_client_fkey FOREIGN KEY (id_client) REFERENCES public.clients(id) ON DELETE RESTRICT,
	CONSTRAINT reservations_id_flight_fkey FOREIGN KEY (id_flight) REFERENCES public.flights(id) ON DELETE RESTRICT
);


CREATE TABLE public.reservations_details (
	id serial4 NOT NULL,
	id_reservation int4 NOT NULL,
	seat_category varchar(255) NOT NULL,
	name_voyageur varchar(255) NOT NULL,
	dtn_voyageur date NOT NULL,
	passport_image varchar(255) NOT NULL,
	price numeric(38, 2) NOT NULL,
	is_promotional bool NOT NULL,
	is_cancel bool NOT NULL,
	cancellation_time timestamptz NULL,
	CONSTRAINT reservations_details_pkey PRIMARY KEY (id),
	CONSTRAINT reservations_details_id_reservation_fkey FOREIGN KEY (id_reservation) REFERENCES public.reservations(id) ON DELETE RESTRICT
);


CREATE TABLE public.seat_configurations (
	id serial4 NOT NULL,
	id_plane int4 NULL,
	category varchar(255) NULL,
	number_of_seats int4 NOT NULL,
	CONSTRAINT seat_configurations_id_plane_category_key UNIQUE (id_plane, category),
	CONSTRAINT seat_configurations_number_of_seats_check CHECK ((number_of_seats > 0)),
	CONSTRAINT seat_configurations_pkey PRIMARY KEY (id),
	CONSTRAINT seat_configurations_id_plane_fkey FOREIGN KEY (id_plane) REFERENCES public.planes(id) ON DELETE CASCADE
);


CREATE TABLE public.flight_prices (
	id serial4 NOT NULL,
	id_flight int4 NULL,
	category varchar(255) NULL,
	base_price numeric(10, 2) NOT NULL,
	CONSTRAINT flight_prices_base_price_check CHECK ((base_price > (0)::numeric)),
	CONSTRAINT flight_prices_id_flight_category_key UNIQUE (id_flight, category),
	CONSTRAINT flight_prices_pkey PRIMARY KEY (id),
	CONSTRAINT flight_prices_id_flight_fkey FOREIGN KEY (id_flight) REFERENCES public.flights(id) ON DELETE CASCADE
);


CREATE TABLE public.flight_promotions (
	id serial4 NOT NULL,
	id_flight int4 NULL,
	category varchar(255) NULL,
	discount_percentage numeric(10, 2) NOT NULL,
	seats_available int4 NOT NULL,
	date_promotion date NULL,
	CONSTRAINT flight_promotions_pkey PRIMARY KEY (id),
	CONSTRAINT flight_promotions_seats_available_check CHECK ((seats_available > 0)),
	CONSTRAINT flight_promotions_id_flight_fkey FOREIGN KEY (id_flight) REFERENCES public.flights(id) ON DELETE CASCADE
);


CREATE TABLE public.flight_reservation (
	id serial4 NOT NULL,
	id_flight int4 NULL,
	reservation_hour_allowed int4 NOT NULL,
	annulation_hour_allowed int4 NOT NULL,
	CONSTRAINT flight_reservation_pkey PRIMARY KEY (id),
	CONSTRAINT flight_reservation_id_flight_fkey FOREIGN KEY (id_flight) REFERENCES public.flights(id) ON DELETE RESTRICT
);
```


and this example code : 


```
package controller;

import j...

@AuthController(roles = { Admin.class })  
@Controller(name = "flight_controller")
public class FlightController {

    private static final String MAIN_TEMPLATE = "main.jsp";

    @Get
    @Url("/form")
    public ModelView redirectToForm() {
        try (Connection connection = new Database().getConnection()){
            // Create ModelView with main template instead of direct view
            ModelView mv = new ModelView(MAIN_TEMPLATE);
            
            City[] cities = City.getAll(connection, City.class);
            Plane[] planes = Plane.getAll(connection, Plane.class);

            // Add data for the form
            mv.add("cities", cities);
            mv.add("planes", planes);
            
            // Add template parameters
            mv.add("activePage", "insert_flight");
            mv.add("contentPage", "form-flight.jsp");
            mv.add("pageTitle", "Insert Flight");

            return mv;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    @Post
    @Url("/insert")
    public ModelView insert(
        @RequestParam(name = "plane") Integer planeId,
        @RequestParam(name = "originCity") Integer originCityId,
        @RequestParam(name = "destinationCity") Integer destinationCityId,
        @RequestParam(name = "departureTime") String departureTime,
        @RequestParam(name = "arrivalTime") String arrivalTime,
        @RequestParam(name = "reservationDeadlineHours") Integer reservationDeadlineHours,
        @RequestParam(name = "cancellationDeadlineHours") Integer cancellationDeadlineHours
    ) {
        try (Connection connection = new Database().getConnection()) {
            Plane plane = Plane.findById(connection, Plane.class, planeId);
            City originCity = City.findById(connection, City.class, originCityId);
            City destinationCity = City.findById(connection, City.class, destinationCityId);
            
            // Create new Flight object
            Flight flight = new Flight();
            flight.setPlane(plane);
            flight.setOriginCity(originCity);
            flight.setDestinationCity(destinationCity);
            flight.setReservationDeadlineHours(reservationDeadlineHours);
            flight.setCancellationDeadlineHours(cancellationDeadlineHours);
            
            if (departureTime != null && !departureTime.isEmpty()) {
                LocalDateTime ldt = LocalDateTime.parse(departureTime);
                flight.setDepartureTime(Timestamp.valueOf(ldt));
            }
            if (arrivalTime != null && !arrivalTime.isEmpty()) {
                LocalDateTime ldt = LocalDateTime.parse(arrivalTime);
                flight.setArrivalTime(Timestamp.valueOf(ldt));
            }
            
            flight.setFlightNumber(UUID.randomUUID().toString().substring(1, 20));
            flight.save(connection);
            return list(); 
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    
    @Get
    @Url("/list")
    public ModelView list() {
        try (Connection connection = new Database().getConnection()) {
            // Create ModelView with main template
            ModelView mv = new ModelView(MAIN_TEMPLATE);
            
            Flight[] flights = Flight.getAll(connection, Flight.class);
            mv.add("flights", flights);
            
            // Add template parameters
            mv.add("activePage", "list_flight");
            mv.add("contentPage", "list-flight.jsp");
            mv.add("pageTitle", "Flight List");
            
            return mv;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    // Load update form
    @Get
    @Url("/edit")
    public ModelView updateForm(@RequestParam(name = "id") Integer id) {
        try (Connection connection = new Database().getConnection()) {
            // Create ModelView with main template
            ModelView mv = new ModelView(MAIN_TEMPLATE);
            
            Flight flight = Flight.findById(connection, Flight.class, id);
            City[] cities = City.getAll(connection, City.class);
            Plane[] planes = Plane.getAll(connection, Plane.class);

            mv.add("flight", flight);
            mv.add("cities", cities);
            mv.add("planes", planes);
            
            // Add template parameters
            mv.add("activePage", "list_flight"); // Keep list active since edit is part of the list flow
            mv.add("contentPage", "edit-flight.jsp");
            mv.add("pageTitle", "Edit Flight");

            return mv;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    // Update flight
    @Post
    @Url("/update")
    public ModelView update(@ModelAttribute("flight") Flight flight) {
        try (Connection connection = new Database().getConnection()) {
            flight.update(connection);
            return list();
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }

    ...
}



package model;

import java.math.BigDecimal;

import mg.jwe.orm.annotations.Column;
import mg.jwe.orm.annotations.ForeignKey;
import mg.jwe.orm.annotations.Id;
import mg.jwe.orm.annotations.Table;
import mg.jwe.orm.base.BaseModel;

@Table(name = "flight_promotions")
public class FlightPromotion extends BaseModel {

    @Id
    @Column(name = "id")
    private Integer id;

    @ForeignKey(table = "flights", column = "id", lazy = false)
    private Flight flight;

    @Column(name = "category")
    private String category;

    @Column(name = "discount_percentage")
    private BigDecimal discountPercentage;

    @Column(name = "seats_available")
    private Integer seatsAvailable;

    @Column(name = "date_promotion")
    private java.sql.Date datePromotion;

    public java.sql.Date getDatePromotion() {
        return datePromotion;
    }

    public void setDatePromotion(java.sql.Date datePromotion) {
        this.datePromotion = datePromotion;
    }


    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public Flight getFlight() {
        return flight;
    }

    public void setFlight(Flight flight) {
        this.flight = flight;
    }

    public String getCategory() {
        return category;
    }

    public void setCategory(String category) {
        this.category = category;
    }

    public BigDecimal getDiscountPercentage() {
        return discountPercentage;
    }

    public void setDiscountPercentage(BigDecimal discountPercentage) {
        this.discountPercentage = discountPercentage;
    }

    public Integer getSeatsAvailable() {
        return seatsAvailable;
    }

    public void setSeatsAvailable(Integer seatsAvailable) {
        this.seatsAvailable = seatsAvailable;
    }
}


package service;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import model.Client;

public class ClientService {
    
    // auth method for client
    public static boolean auth(Connection connection, Client client) 
        throws Exception 
    {
        String query = "SELECT COUNT(*) FROM clients WHERE email = ? AND password_hash = ?";
        
        try (PreparedStatement statement = connection.prepareStatement(query)) {
            statement.setString(1, client.getEmail());
            statement.setString(2, client.getPassword());


            System.out.println("email: " + client.getEmail());
            System.out.println("password: " + client.getPassword());
            
            try (ResultSet resultSet = statement.executeQuery()) {
                if (resultSet.next()) 
                { return resultSet.getInt(1) > 0; }
            }
        } 
        
        catch (Exception e) 
        { throw e; }

        return false;
    } 

    public static void savePassportImage(Connection connection, Client client, String path) 
        throws Exception 
    {
        String query = "UPDATE clients SET passport_image = ? WHERE id = ?";

        try (PreparedStatement preparedStatement = connection.prepareStatement(query)) {
            preparedStatement.setString(1, path);          
            preparedStatement.setInt(2, client.getId());  

            int rowsAffected = preparedStatement.executeUpdate();

            if (rowsAffected == 0) {
                throw new Exception("Failed to update passport image: Client with ID " + client.getId() + " not found.");
            }

            System.out.println("Passport image updated successfully for client ID: " + client.getId());
        } 
        
        catch (SQLException e) {
            throw new Exception("Error updating passport image in the database: " + e.getMessage(), e);
        }
    }
}

JSP view : 

<%@ page import="model.*" %>

<%
  Flight[] flights = (Flight[]) request.getAttribute("flights");
%>

<h2>Flight Promotion Insertion</h2>

<form action="insert_promotion" method="post">
  <p>Flight: </p>
  <select name="flight" id="flight" required>
    <% for (Flight flight : flights) { %>
      <option value="<%= flight.getId() %>">
        <%= flight.getFlightNumber() %> 
        (<%= flight.getOriginCity().getCityName() %> - <%= flight.getDestinationCity().getCityName() %>)
      </option>
    <% } %>
  </select>
  <br>

  <p>Category:</p>
  <select name="category" id="category" required>
    <option value="Economy">Economy</option>
    <option value="Business">Business</option>
    <option value="First Class">First Class</option>
  </select>
  <br>

  <p>New Promotional Price:</p>
  <input type="number" name="discountPercentage" id="discountPercentage" required>
  <br>

  <p>Seats Available:</p>
  <input type="number" name="seatsAvailable" id="seatsAvailable" required>
  <br>

  <p>Promotion Date:</p>
  <input type="date" name="datePromotion" id="datePromotion" required>
  <br>


  <input type="submit" value="Create Promotion">
</form>

```


**Task:**
Modify the reservation logic to handle **cumulative promotional seats** for flights.

---

### Business Rules / Logic

1. **Discount representation**

   * The column `discount_percentage` is no longer used as a percentage.
   * Instead, it directly stores the **promotional price** (label was updated, but the column name remains the same).
   * âœ… This part already works fine, no changes needed.

2. **Promotion deadline**

   * The column `date_promotion` in the `FlightPromotion` table represents the last date when a promotional booking is valid.

3. **Seat booking cases**
   Example:

   * Flight **A** (category = Economic, promotion price = \$100)

     * Seats on promotion: 10
     * Bookings on **18/08/2025**:

       * Client 1 â†’ booked & paid **3 seats**
       * Client 2 â†’ booked but unpaid **1 seat**
     * Summary:

       * Total booked = 4 (3 paid + 1 unpaid)
       * Remaining unbooked = 10 âˆ’ 4 = **6 seats**

   * Later, for the same flight **A** (same category = Economic, new promotion price = \$85 starting **20/08/2025**)

     * Seats on new promotion: 5
     * Remaining unbooked from previous promotion (same flight + same category) = 6
     * Total available at new promotion price = 5 + 6 = **11 seats**

   âœ… Rule: **Unbooked seats are carried over** to the next promotion **if itâ€™s the same flight and category.**

4. **Handling exceptions**

   * If a booking exists but is **unpaid** â†’ cancel the reservation.
   * If unbooked seats have **no matching future promotion** (same flight + same category) â†’ delete those promotions (do not carry over).

---

### Implementation Requirement

* Create a new page called **"Manage Unbooked Seats"**.
* The page should contain a **form with a single date input**.
* When the form is submitted:

  1. You can modify the DB conception, create new table if required:
  2. Call a method in a **service class** that takes this date as a parameter (with DB connection if needed).
  3. The method should execute the logic described above:

     * Cancel unpaid reservations.
     * Carry over unbooked seats to the next matching promotion (same flight + same category).
     * Remove promotions for unbooked seats if no matching promotion exists.


---

ðŸ‘‰ This way, when the **button is triggered** in the form:

* Seats move to the next promotion (if eligible).
* Unpaid reservations are canceled.
* Invalid promotions are deleted.




-- CA vol 2

SELECT
    f.id AS flight_id,
    f.flight_number,
    SUM(rd.price) AS chiffre_affaire
FROM reservations_details rd
JOIN reservations r ON rd.id_reservation = r.id
JOIN flights f ON r.id_flight = f.id
WHERE r.payment_status = 'paid'
  AND rd.is_cancel = false and f.flight_number = 'FL1002'
GROUP BY f.id, f.flight_number
ORDER BY f.flight_number;


-- manque a gagner vol 1 jusqu'au 23 Aout

WITH potential AS (
    SELECT 
        f.id AS flight_id,
        f.flight_number,
        SUM(fp.seats_available * fp.discount_percentage) AS potential_revenue
    FROM flights f
    JOIN flight_promotions fp 
        ON fp.id_flight = f.id
    JOIN flight_prices fr 
        ON fr.id_flight = f.id 
       AND fr.category = fp.category
    WHERE f.flight_number = 'FL1001'
    GROUP BY f.id, f.flight_number
),
real AS (
    SELECT 
        f.id AS flight_id,
        SUM(rd.price) AS actual_revenue
    FROM reservations_details rd
    JOIN reservations r 
        ON rd.id_reservation = r.id
    JOIN flights f 
        ON r.id_flight = f.id
    WHERE f.flight_number = 'FL1001'
      AND r.payment_status = 'paid'
      AND rd.is_cancel = false
      AND r.payment_time <= '2025-08-23'
    GROUP BY f.id
)
SELECT 
    p.flight_number,
    (p.potential_revenue - COALESCE(r.actual_revenue, 0)) AS manque_a_gagner
FROM potential p
LEFT JOIN real r 
    ON p.flight_id = r.flight_id;
